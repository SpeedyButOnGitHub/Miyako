# REFCHANGE 2025-09-11 19:50

## Phase 1 – Repository-wide Analysis (Initial Pass)

(This file will be appended as phases progress.)

### Event Listener Attach Points
- messages: `src/events/messages.js` (guard present: `client.__messageListenerAttached`)
- interactions: `src/events/interactionEvents.js` (guard present: `client.__interactionListenerAttached`)
- scheduler: `src/utils/scheduler.js` exports `startScheduler` (idempotency relies on external call discipline; no internal guard yet) – candidate for guard.

### Potential Duplication Risks
- `index.js` explicitly deletes legacy `events/messageEvents` cache – mitigates older handler duplication.
- Scheduler `startScheduler` can be invoked multiple times without internal protection (risk: multiple interval loops) – add `_started` flag.
- ActiveMenus handlers registered at module load sites (index, commands, events). Re-registration on hot reload could duplicate if module cache invalidated.

### Multiple Reply / Double Send Hotspots
- Interaction handlers in `interactionEvents.js` often use `interaction.reply()` directly after conditional logic; most are single-path, but race conditions possible if errors thrown after partial reply.
- Some branches use `interaction.deferUpdate()` followed by `message.edit()` – safe.
- No obvious patterns of both `reply` + `followUp` for the same operation currently, aside from flows where ephemeral confirmation then root message edit happen intentionally.

### Scheduling / Auto Message Code
- Core functions: `computeNextRun`, `runScheduleOnce`, `startScheduler` in `src/utils/scheduler.js`.
- Manual trigger + anchor logic: `src/commands/schedule/actions.js` (`ensureAnchor`, `manualTriggerAutoMessage`).
- Notification send/edit logic: `src/commands/schedule/notifications.js` touches `__clockIn` message updates.

### Clock-In Embed & State
- Clock-in selection handling and rendering presently in `interactionEvents.js` (dynamic rebuild, local embed object) and in `schedule/notifications.js` (initial send path).
- Uses `ev.__clockIn.positions` with role buckets: instance_manager (1 slot), manager, bouncer, bartender, backup, maybe.
- Heuristic recovery pathways implemented for missing event resolution.

### Shared Object Mutation Risks
- Clock-in embed built inline each update; fresh object each time – OK.
- Some embed utilities may reuse builder objects inside `utils/embeds.js` (not yet analyzed in depth) – to review before mutation changes.

### TTL / Dedup Helpers
- Message processing guard: `client.__handledMessages` set in `messages.js` (capped at 10k entries) prevents duplicate per-message processing.
- No generic `sendOnce` referenced in initial scan (test file exists `__tests__/sendOnce.test.js` implying a helper somewhere – will locate for integration).

### Command Logging
- Present at `src/utils/commandLogger.js` with start/finish, diff capability, channel reporting; integrated in `messages.js` and via instrumentation for interactions.

### Crash/Error Handling
- Early initialization in `index.js` via `./utils/crashReporter`. Need to inspect crashReporter for throttling & persistence (future phase).
- Console error interception layer in `index.js` ensures capture.

### ActiveMenus
- Registration scattered (help, profile, scripts, configMenu, errors, purgeConfirm, status, schedule events). Central manager at `utils/activeMenus.js` (not yet inspected) – need to confirm it prunes sessions & avoids memory leak.

### JSON Storage Mutation Points
- `eventsStorage.js` -> `events.json` (runtime path abstraction).
- Schedule & clock-in modifications call `updateEvent()` (should persist through write queue; confirm atomicity).

### Immediate Observations / Suspicious Items
| Area | File | Concern |
|------|------|---------|
| Scheduler | `utils/scheduler.js` | Lack of internal `_started` guard could double-loop. |
| Clock-In | `interactionEvents.js` & `schedule/notifications.js` | Two places generate clock-in embed (risk of divergence). |
| Auto Message Edit Consolidation | `schedule/index.js` + `schedule/actions.js` + modal handlers in `interactionEvents.js` | Existing modals use separate add/offset/message/channel flows – consolidation pending. |
| Command Logging | `commandLogger.js` | Already robust; need expected-vs-actual test coverage. |
| Safe Send Helper | (Not found yet) | Central `safeReply` not present; need unified helper. |
| Duplicate ActiveMenus Handler Risk | Multi-registration on hot reload | Add idempotent guard or doc note. |

### Next Steps (Phase 2 Targets)
1. Add internal guard to `startScheduler`.
2. Implement `safeReply` utility + apply to high-risk branches.
3. Normalize single clock-in embed template source (introduce template module, use in both creation & update).
4. Prepare duplication test harness.

### Phase 2 Progress (Incremental)
* Added idempotent guard `_started` to `src/utils/scheduler.js` to prevent multiple interval loops.
* Introduced `src/utils/safeReply.js` (single-send TTL guard for replies).
* Added canonical clock-in template module `src/utils/clockinTemplate.js`.
* Refactored clock-in embed construction in `interactionEvents.js` and `commands/schedule/notifications.js` to use unified template.
* Added tests: `duplication.test.js`, `clockinEmbed.test.js`, `commandLogger.test.js`.
* Added script: `scripts/compare-logs.js` for summarizing command log diffs.

### Phase 3 – Auto Message Edit Consolidation (In Progress)
* Refactored `handleEventNotificationModal` in `src/commands/schedule/index.js` to support only unified `add` and `edit` modals; removed legacy granular modal paths (`offset`, `msg`, `channel`, `deleteafter`).
* Added `deleteafter` field to Add Auto Message modal handling so TTL can be set at creation.
* Removed unused handler `event_notif_edit_channel_` (channel now edited within unified Edit modal).
* Updated event auto-message update flow to preserve existing manager message refresh logic.
* Next: integrate safeReply across schedule handlers and add `autoedit.test.js` covering end-to-end edit persistence & TTL parsing edge cases.
* Integrated `safeReply` into `schedule/index.js` for validation/error replies (create/edit event + auto-message add/edit). Removed direct multi-path interaction.reply calls for those validations.
* Deprecated local safeReply in `utils/errorUtil.js` and re-export unified `utils/safeReply.js` implementation there.
* Introduced `utils/channelIdLog.js` to relocate event `channelId` persistence out of `events.json` into `data/private/channelIds.json` (gitignored) to reduce sensitive channel leakage in versioned runtime data.
* Modified `utils/eventsStorage.js` to strip `channelId` on disk while retaining it at runtime and logging updates via `recordEventChannel`.
* Added `data/private/` to `.gitignore` to exclude channel ID log file from version control.
* Added migration script `scripts/migrate-event-channel-ids.js` to retroactively extract existing `channelId` values from `events.json` into private log and rewrite sanitized events file.
* Introduced `eventsRuntimeLog` to offload volatile fields (`anchorChannelId`, `anchorMessageId`, `__notifMsgs`, `__clockIn`, `dynamicBaseContent`) from `events.json`; they are now stored in `data/private/eventsRuntime.json` (gitignored). Persistence layer merges runtime on read; events.json will be reduced to stable definitions only.

### Phase 3 Addendum – Runtime Volatile Field Migration
* Added migration script `scripts/migrate-event-runtime.js` to extract existing volatile fields from any legacy `events.json` into the runtime overlay store (`data/private/eventsRuntime.json`).
* Updated `eventsStorage.sanitize` to also strip added volatile keys (`anchorChannelId`, `anchorMessageId`, `__notifMsgs`, `__clockIn`, `dynamicBaseContent`) plus any `__auto_*` schedule run markers going forward to prevent churn in version control.
* After running `npm run migrate:event-runtime` (or the yarn/pnpm equivalent) the tracked `data/events.json` should no longer contain ephemeral fields; verification: only stable definitions (id, name, schedule config, autoMessages definitions) remain.
* This change completes the separation of persistent configuration vs. ephemeral runtime state for events.

(Additional sections will be appended with concrete diffs, tests, and verification logs.)
